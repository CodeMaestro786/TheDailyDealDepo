<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | Daily Deal Depo</title>
<link rel="stylesheet" href="styles.css">
<script type="module">
if(localStorage.getItem('adminLoggedIn')!=='true'){
  alert('Unauthorized'); window.location.href='admin-login.html';
}

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl='https://knjpzfhpharpsrnzpmvg.supabase.co';
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuanB6ZmhwaGFycHNybnpwbXZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMzg4OTgsImV4cCI6MjA3MjkxNDg5OH0.HO_p71TKAKYXEsMHoWVMgGWCk2rj9YajZs53BRRDTgU';
const supabase = createClient(supabaseUrl,supabaseKey);

async function loadProducts(){
  const {data,error}=await supabase.from('products').select('*');
  if(error) return console.error(error);
  const container=document.getElementById('productsContainer');
  container.innerHTML='';
  data.forEach(product=>{
    const div=document.createElement('div');
    div.classList.add('product');
    div.innerHTML=`
      <img src="${product.image}" alt="${product.name}">
      <h3>${product.name}</h3>
      <p>${product.description}</p>
      <p>R${product.price}</p>
      <button onclick="editProduct('${product.id}')">Edit</button>
      <button onclick="deleteProduct('${product.id}')">Delete</button>
    `;
    container.appendChild(div);
  });
}

async function addProduct(e){
  e.preventDefault();
  const name=document.getElementById('name').value;
  const price=parseFloat(document.getElementById('price').value);
  const description=document.getElementById('description').value;
  const file=document.getElementById('imageFile').files[0];

  // Upload image to Supabase Storage
  const fileExt=file.name.split('.').pop();
  const fileName=`${Date.now()}.${fileExt}`;
  const {data:uploadData,error:uploadError}=await supabase.storage.from('product-images').upload(fileName,file);
  if(uploadError) return alert('Image upload failed');

  const {publicURL}=supabase.storage.from('product-images').getPublicUrl(fileName);

  const {error}=await supabase.from('products').insert([{name,price,description,image:publicURL}]);
  if(error) alert('Error adding product'); else {alert('Added'); loadProducts();}
}

async function deleteProduct(id){
  await supabase.from('products').delete().eq('id',id); loadProducts();
}

async function editProduct(id){
  const name=prompt('New name:'); const price=prompt('New price:');
  const description=prompt('New description:');
  await supabase.from('products').update({name,price,description}).eq('id',id);
  loadProducts();
}

window.onload=loadProducts;
</script>
</head>
<body>
<header>
<h1>Admin Dashboard</h1>
<button onclick="localStorage.removeItem('adminLoggedIn');window.location.href='admin-login.html'">Logout</button>
</header>
<main>
<section>
<h2>Add Product</h2>
<form onsubmit="addProduct(event)">
<input type="text" id="name" placeholder="Name" required>
<input type="number" id="price" placeholder="Price" required>
<textarea id="description" placeholder="Description" required></textarea>
<input type="file" id="imageFile" accept="image/*" required>
<button type="submit">Add Product</button>
</form>
</section>
<section>
<h2>Product List</h2>
<div id="productsContainer"></div>
</section>
</main>
</body>
</html>
